name: Build SigmaSpy

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: "5.1"

      - name: Setup Aftman
        uses: ok-nick/setup-aftman@v0.3.0

      - name: Install tools via aftman
        run: aftman install

      - name: Run build with Lune
        run: |
          echo "Using Lune to run the build script"
          lune run build/build.lua build/config.json

      - name: Verify built files
        run: |
          echo "=== Built files ==="
          ls -lh Main.lua dist/main.lua 2>/dev/null || true

      - name: Commit built files back to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Main.lua dist/main.lua || true
          
          if ! git diff --cached --quiet; then
            git commit -m "[AUTO] Upload built files"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit"
          fi

      - name: Upload build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sigma-spy-build
          path: |
            Main.lua
            dist/main.lua
